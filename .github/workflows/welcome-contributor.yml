name: Welcome New Contributors

on:
  pull_request:
    types: [opened]

permissions:
  issues: write
  pull-requests: write

jobs:
  welcome:
    name: Welcome New Contributor
    runs-on: ubuntu-latest
    steps:
      - name: Check if first contribution
        uses: actions/github-script@v8
        id: check-contributor
        with:
          script: |
            const contributor = context.payload.pull_request.user.login;
            const repo = context.repo;
            
            // Check if this is the first PR from this contributor
            const { data: prs } = await github.rest.pulls.list({
              owner: repo.owner,
              repo: repo.repo,
              state: 'all',
              creator: contributor,
            });
            
            // Filter out the current PR
            const previousPRs = prs.filter(pr => pr.number !== context.payload.pull_request.number);
            
            const isFirstContribution = previousPRs.length === 0;
            
            core.setOutput('is_first', isFirstContribution);
            core.setOutput('contributor', contributor);

      - name: Welcome first-time contributor
        if: steps.check-contributor.outputs.is_first == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const contributor = '${{ steps.check-contributor.outputs.contributor }}';
            const prNumber = context.payload.pull_request.number;
            
            const comment = `üéâ **Welcome to HaemoLogix, @${contributor}!** ü©∏

            Thank you for making your first contribution to our project! We're thrilled to have you join our mission to make blood donation more efficient and save lives.

            ## üåü What Happens Next?

            1. **Review Process**: Our team will review your PR and provide feedback
            2. **CI Checks**: Automated tests and checks will run
            3. **Collaboration**: We may ask questions or request changes
            4. **Merge**: Once approved, your contribution will be merged!

            ## üìö Helpful Resources

            - [Contributing Guide](https://github.com/${{ github.repository }}/blob/main/CONTRIBUTING.md) - Learn our contribution guidelines
            - [Code of Conduct](https://github.com/${{ github.repository }}/blob/main/CODE_OF_CONDUCT.md) - Community standards
            - [Documentation](https://github.com/${{ github.repository }}/tree/main/docs) - Project documentation

            ## üí¨ Questions?

            Don't hesitate to:
            - Ask questions in the PR comments
            - Join our [Discussions](https://github.com/${{ github.repository }}/discussions)
            - Email us: mdalam4884@gmail.com

            We're here to help! Thank you for contributing to HaemoLogix! üôè

            ---
            *This is an automated welcome message for first-time contributors.*`;

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment,
            });

            // Add welcome label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['first-time-contributor'],
            });
