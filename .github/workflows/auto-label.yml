name: Auto Label Issues and PRs

on:
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  label-issues:
    name: Auto Label Issues
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: Auto Label Issues
        uses: actions/labeler@v5
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          configuration-path: .github/labeler.yml
          sync-labels: false

  label-prs:
    name: Auto Label Pull Requests
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Auto Label PRs
        uses: actions/labeler@v5
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          configuration-path: .github/labeler.yml
          sync-labels: false

      - name: Label by File Changes
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });

            const labels = new Set();
            const filePaths = files.data.map(f => f.filename);

            // Determine labels based on file paths
            if (filePaths.some(f => f.startsWith('app/') || f.startsWith('components/'))) {
              labels.add('frontend');
            }
            if (filePaths.some(f => f.startsWith('app/api/') || f.startsWith('lib/'))) {
              labels.add('backend');
            }
            if (filePaths.some(f => f.includes('agent') || f.includes('Agent'))) {
              labels.add('agent-system');
            }
            if (filePaths.some(f => f.startsWith('ml/'))) {
              labels.add('machine-learning');
            }
            if (filePaths.some(f => f.includes('.test.') || f.includes('.spec.'))) {
              labels.add('testing');
            }
            if (filePaths.some(f => f.endsWith('.md') || f.startsWith('docs/'))) {
              labels.add('documentation');
            }
            if (filePaths.some(f => f.includes('prisma/') || f.includes('schema.prisma'))) {
              labels.add('database');
            }
            if (filePaths.some(f => f.includes('.github/workflows/'))) {
              labels.add('ci-cd');
            }

            // Add labels
            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: Array.from(labels),
              });
            }

      - name: Check PR Size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });

            const additions = files.data.reduce((sum, file) => sum + file.additions, 0);
            const deletions = files.data.reduce((sum, file) => sum + file.deletions, 0);
            const changes = additions + deletions;
            const fileCount = files.data.length;

            let sizeLabel = 'size: small';
            let comment = '';

            if (changes > 1000 || fileCount > 50) {
              sizeLabel = 'size: xl';
              comment = `âš ï¸ **Large Pull Request Detected**

              This PR has **${changes}** changes across **${fileCount}** files. Consider breaking this into smaller, more focused PRs for easier review.

              - Large PRs are harder to review and test
              - Smaller PRs can be merged faster
              - Consider splitting by feature or component

              If this PR must be large, please ensure:
              - âœ… All changes are related to a single feature/fix
              - âœ… Comprehensive testing has been done
              - âœ… Documentation is updated
              - âœ… Breaking changes are clearly documented`;
            } else if (changes > 500 || fileCount > 30) {
              sizeLabel = 'size: large';
              comment = `ðŸ“¦ **Medium-Large Pull Request**

              This PR has **${changes}** changes across **${fileCount}** files. Please ensure thorough testing and documentation.`;
            } else if (changes > 200 || fileCount > 15) {
              sizeLabel = 'size: medium';
            }

            // Add size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: [sizeLabel],
            });

            // Comment if PR is large
            if (comment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment,
              });
            }
